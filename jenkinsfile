pipeline {
    agent any

    environment {
        // Nom de l'image Docker
        DOCKER_IMAGE = 'virus-analyzer'
        DOCKER_TAG = "${BUILD_NUMBER}"
        // Registry Docker (optionnel - décommentez si vous utilisez un registry)
        // DOCKER_REGISTRY = 'your-registry.com'
        // DOCKER_CREDENTIALS = 'docker-credentials-id'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Install Dependencies') {
            steps {
                dir('backend') {
                    sh 'pip install -r requirements.txt'
                }
            }
        }

        stage('Run Tests + Coverage') {
            steps {
                dir('backend') {
                    sh 'coverage run manage.py test'
                    sh 'coverage xml'
                }
            }
        }

        stage('SonarQube Analysis') {
            steps {
                dir('backend') {
                    script {
                        def scannerHome = tool 'SonarScanner'
                        withSonarQubeEnv('SonarQube') {
                            sh "${scannerHome}/bin/sonar-scanner"
                        }
                    }
                }
            }
        }

        stage('Quality Gate') {
            steps {
                timeout(time: 5, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: true
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                dir('backend') {
                    script {
                        // Construction de l'image Docker
                        docker.build("${DOCKER_IMAGE}:${DOCKER_TAG}")
                        // Tag aussi avec 'latest'
                        sh "docker tag ${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_IMAGE}:latest"
                    }
                }
            }
        }

        / Optionnel: Push vers un registry Docker
        // stage('Push to Registry') {
        //     steps {
        //         script {
        //             docker.withRegistry("https://${DOCKER_REGISTRY}", DOCKER_CREDENTIALS) {
        //                 docker.image("${DOCKER_IMAGE}:${DOCKER_TAG}").push()
        //                 docker.image("${DOCKER_IMAGE}:latest").push()
        //             }
        //         }
        //     }
        // }

        stage('Cleanup') {
            steps {
                // Nettoyage des images anciennes (optionnel)
                sh '''
                    docker image prune -f
                '''
            }
        }
    }

    post {
        always {
            // Archiver les rapports de couverture
            junit allowEmptyResults: true, testResults: '**/test-results.xml'
            publishHTML(target: [
                allowMissing: true,
                alwaysLinkToLastBuild: false,
                keepAll: true,
                reportDir: 'backend',
                reportFiles: 'coverage.xml',
                reportName: 'Coverage Report'
            ])
        }
        success {
            echo "✅ Pipeline terminé avec succès! Image: ${DOCKER_IMAGE}:${DOCKER_TAG}"
        }
        failure {
            echo "❌ Pipeline échoué"
        }
    }
}